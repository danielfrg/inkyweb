---
- name: Install dependencies
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
    update_cache: true
  with_items:
    - git
  become: true

- name: Ensure local bin directory exists
  file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: '0755'

- name: Install uv
  shell: "curl -LsSf https://astral.sh/uv/install.sh | sh"
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/uv"

- name: Enable I2C using raspi-config
  command: "raspi-config nonint do_i2c 0"
  become: yes

- name: Enable SPI using raspi-config
  command: "raspi-config nonint do_spi 0"
  become: yes

- name: Insert dtoverlay for spi0-0cs in config.txt
  lineinfile:
    path: /boot/firmware/config.txt
    insertafter: '^dtparam=spi=on'
    line: "dtoverlay=spi0-0cs"
    state: present
  become: yes
